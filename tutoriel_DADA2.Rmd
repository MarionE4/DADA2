---
title: "R Notebook"
output: github_document
---

```{bash, eval=FALSE}
wget https://github.com/ANF-MetaBioDiv/course-material/archive/refs/heads/main.zip
unzip main.zip
```

(re)Défini la racine de notre projet sur notre ordinateur.
```{r, eval=FALSE}
refdb_folder <- here::here("data", "refdb")
refdb_folder
```
Création du vrai dossier refdb_folder (si rfdb_folder n'existe pas créer le, et possibilité créer sous dossier).
```{r, eval=FALSE}
if (!dir.exists(refdb_folder)) dir.create(refdb_folder,recursive = TRUE)
```


```{bash, eval=FALSE}
cp -R course-material-main/data/raw ./data
```


Lors téléchargement de données R s'arrête au bout de 60 secondes, changement de ce temps à 20 min.
```{r, eval=FALSE}
getOption("timeout")
options(timeout = 1200)
```

Sauver le chemin de refdb dans l'espace de travail DANS un objet.
```{r, eval=FALSE}
silva_train_set <- file.path(refdb_folder, 
                             "silva_nr99_v138.1_train_set.fa.gz")
silva_species_assignment <- file.path(refdb_folder, 
                                      "silva_species_assignment_v138.1.fa.gz")
```

Téléchargement des fichiers s'ils n'existent pas.
```{r, eval=FALSE}
if (!file.exists(silva_train_set)){
  download.file(
    "https://zenodo.org/record/4587955/files/silva_nr99_v138.1_train_set.fa.gz",
    silva_train_set,
    quiet = TRUE
  )
}

if (!file.exists(silva_species_assignment)) {
  download.file(
    "https://zenodo.org/record/4587955/files/silva_species_assignment_v138.1.fa.gz",
    silva_species_assignment,
    quiet = TRUE
  )
}

```


```{r}
devtools::load_all(path = "/home/rstudio/DADA2/course-material-main/R/")
```



Sauvegarde du chemin d'accès au répertoire contenant les données brutes dans un objet.
```{r}
path_to_fastqs <- here::here("data", "raw")
```

Faire une liste avec les fichiers forward. 
```{r}
fnFs <- sort(list.files(path_to_fastqs,
                        pattern = "_R1.fastq.gz",
                        full.names=TRUE))
```

Faire la même chose avec les fichiers reverse.
```{r}
fnRs <- sort(list.files(path_to_fastqs,
                        pattern = "_R2.fastq.gz",
                        full.names = TRUE))
```

basename() : permet de garder le nom du fichier ;

strsplit() : sépare un chaîne de caractère au niveau d'un caractère donné ; 
|> : permet de mettre plusieurs fonctions à la suite sans avoir à utiliser de multiples objets ;

sapply() : ici extrait le premier élément de la liste.
```{r}
sample_names <- basename(fnFs) |>
  strsplit(split = "_") |>
  sapply(head, 1) |>
  head()
```

1. Création d'un fichier où stocker les données de sortie du qualityprofile
2. Vérification de la qualité des profils
```{r, eval=FALSE}
quality_folder <- here::here("outputs",
                             "dada2",
                             "quality_plots")

if (!dir.create(quality_folder)) {
  dir.create(quality_folder, recursive = TRUE)
}

qualityprofile(fnFs,
               fnRs,
               file.path(quality_folder, "quality_plots.pdf"))
```

Création d'un dossier dans lequel sera enregistré les reads une fois les nucléotides avec une qualité médiocre coupée.
```{r}
path_to_trimmed_reads <- here::here(
  "outputs",
  "dada2",
  "trimmed"
)

if (!dir.exists(path_to_trimmed_reads)) dir.create(path_to_trimmed_reads, recursive = TRUE)
```

Les données correspondent à la région V3-V4 (460pb), en utilisant les amorces Pro341F (CCTACGGGNBGCASCASCAG) et Pro805R (GACTACNVGGGTATTCTAAT).
```{r}
primer_fwd  <- "CCTACGGGNBGCASCAG"
primer_rev  <- "GACTACNVGGGTATCTAAT"
```

Trouver les amorces des forward dans les reads forward.
```{r}
Biostrings::readDNAStringSet(
  fnFs[1],
  format = "fastq",
  nrec = 10
)
```
Trouver les amorces reverse dans les reads reverse.
```{r}
Biostrings::readDNAStringSet(
  fnRs[1],
  format = "fastq",
  nrec = 10
)
```

Copie du dossier bash (comme R avant) dans le dossier DADA2
```{bash}
pwd
cp -R /home/rstudio/DADA2/course-material-main/bash .
```


On enlève les séquences des amorces des reads
```{r}
(primer_log <- primer_trim(
  forward_files = fnFs,
  reverse_files = fnRs,
  primer_fwd = primer_fwd,
  primer_rev = primer_rev,
  output_dir = path_to_trimmed_reads,
  min_size = 200
))
```

```{r}
nopFw <- sort(list.files(path_to_trimmed_reads, pattern = "R1", full.names = TRUE))
nopRv <- sort(list.files(path_to_trimmed_reads, pattern = "R2", full.names = TRUE))
```


5.

Création d'un dossier et des listes de chemins d'accès pour les reads qui seront filtrés.
```{r}
path_to_filtered_reads <- here::here("outputs", "dada2","filtered")
if (!dir.exists(path_to_filtered_reads)) dir.create(path_to_filtered_reads, recursive = TRUE)

filtFs <- file.path(path_to_filtered_reads, basename(fnFs))
filtRs <- file.path(path_to_filtered_reads, basename(fnRs))
```

Pour faire le lien entre les fichiers et les noms d'échantillons, nommer simplement le vecteur de noms de fichiers en utilisant les noms d'échantillons 
```{r}
names(filtFs) <- sample_names
names(filtRs) <- sample_names
```

La fonction filterAndTrim permet de filtrer et couper plusieurs fichiers fastq en fonctions de plusieurs critères définis par l'utilisateur. Puis génère un ou plusieurs fichiers fastq contenant les reads découpés et filtrés.
```{r}
(out <- dada2::filterAndTrim(
  fwd = nopFw,
  filt = filtFs,
  rev = nopRv,
  filt.rev = filtRs,
  minLen = 150,
  matchIDs = TRUE,
  maxN = 0,
  maxEE = c(3, 3),
  truncQ = 2
))
```

6.1
Enlever les erreurs de séquençage : regarde la séquence majoritaire et corrige


6.2
Ne garder qu'un seul exemplaire des séquences en multiples exemplaires et mettre dans un fichier combien de fois on a trouvé cette séquence.


7. 
Alignement des forward et des reverse = création de contigue.
Plu de R1 et R2 -> contigue


8. 
matrice d'observation

9.
chimère former pdt PCR :
lors réplication ADNpol peut se détacher et arrêter polymérisation -> fin PCR 1 brin mère et un petit brin fille. Ce petit brin fille peut venir s'amorcer/fixer au brin mère d'une autre bactérie et l'ADNpol va reprendre élongation. -> Création de chimère : brin mixte bactérie 1 et 2.


10. 
assignation taxonomique
calcul par pourcentage de chance en partant du haut de l'arbre et descend peut à peut. sarrête juste avant quand le pourcentage est inférieur à celui défini.
Assignation à une espèce -> ne dépend que de la base de données.

11.
téléchargement de l'environnement R sur notre ordinateur.





